generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String   @id @default(cuid())
  email                String   @unique
  passwordHash         String
  username             String   @unique
  displayName          String?
  bio                  String?
  avatarUrl            String?
  youtubeChannelId     String?
  tiktokUsername       String?
  instagramUsername    String?
  subscriptionStatus   String   @default("TRIAL")
  subscriptionExpiresAt DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  materials            Material[]
  videoMaterials       VideoMaterial[]
  subscription         Subscription?
  instagramIntegration InstagramIntegration?

  @@map("users")
}

model Material {
  id            String          @id @default(cuid())
  creatorId     String
  title         String
  description   String?
  fileUrl       String
  fileType      String
  secretCode    String
  downloadCount Int             @default(0)
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  creator        User            @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  accessRequests AccessRequest[]
  videoMaterials VideoMaterial[]

  @@map("materials")
}

model AccessRequest {
  id                String   @id @default(cuid())
  materialId        String
  followerEmail     String
  followerName      String?
  secretCodeAttempt String
  screenshotUrl     String
  status            String   @default("PENDING")
  rejectionReason   String?
  reviewedAt        DateTime?
  createdAt         DateTime @default(now())

  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@map("access_requests")
}

model VideoMaterial {
  id             String   @id @default(cuid())
  creatorId      String
  materialId     String
  videoPlatform  String
  videoId        String
  videoTitle     String
  videoThumbnail String
  createdAt      DateTime @default(now())

  creator  User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@map("video_materials")
}

model Subscription {
  id                   String @id @default(cuid())
  userId               String @unique
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  status               String @default("ACTIVE")
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model InstagramIntegration {
  id              String   @id @default(cuid())
  userId          String   @unique
  instagramUserId String
  accessToken     String   // Will be encrypted
  pageId          String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  automations Automation[]

  @@map("instagram_integrations")
}

model Automation {
  id            String   @id @default(cuid())
  integrationId String
  name          String
  trigger       String   // COMMENT, LIKE, DM, STORY_MENTION, REEL_COMMENT
  isActive      Boolean  @default(true)
  flowData      Json     // React Flow nodes and edges
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  integration InstagramIntegration  @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  executions  AutomationExecution[]

  @@map("automations")
}

model AutomationExecution {
  id           String   @id @default(cuid())
  automationId String
  triggeredBy  String   // Instagram user ID
  triggerData  Json     // Comment text, media ID, etc.
  status       String   // PENDING, RUNNING, COMPLETED, FAILED
  errorMessage String?
  executedAt   DateTime @default(now())

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@map("automation_executions")
}
